package Q3_2;

import java.io.IOException;
import java.text.DecimalFormat;
import java.util.*;
import org.apache.hadoop.fs.Path;
import org.apache.hadoop.conf.*;
import org.apache.hadoop.io.*;
import org.apache.hadoop.mapred.*;
import org.apache.hadoop.util.*;


public class Q3_2 {
	public static class Map extends MapReduceBase implements Mapper<LongWritable, Text, Text, Text> {
		private Text cid = new Text();
		private Text tranSum = new Text();
		public void map(LongWritable key, Text value,OutputCollector<Text, Text> output, 
				Reporter reporter) throws IOException {
          StringTokenizer itr = new StringTokenizer(value.toString());
          while (itr.hasMoreTokens()) {
      	  String[] tokens =itr.nextToken().split(",");
     	  if(tokens.length != 5)
		  return;
	
	      String result = tokens[1];
	      String val = tokens[2];

	      tranSum.set(val);

          cid.set(result);
          output.collect(cid, tranSum);
		  }
	   }
	}

	public static class Reduce extends MapReduceBase implements Reducer<Text, Text, Text, Text> {
		
		public void reduce(Text key, Iterator<Text> values,OutputCollector<Text, Text> output, 
				Reporter reporter)throws IOException {

     		long count = 0;
			float sum = 0.00000f;
			while (values.hasNext()) {
				String[] s = values.next().toString().split(" ");
				float t = Float.parseFloat(s[0]);
				sum += t;
				count += 1;
			}
			
			String l1 = Float.toString(sum);
			String l2 = Long.toString(count);
			Text res = new Text();
			res.set(l1 + "    " + l2);
			output.collect(key, res);
			}
	}



	public static void main(String[] args) throws Exception{
	     JobConf conf = new JobConf(Q3_2.class);
	     conf.setJobName("Q3_2");
	     
	     conf.setMapOutputKeyClass(Text.class);
	     conf.setMapOutputValueClass(Text.class);
	     
	     conf.setOutputKeyClass(Text.class);
	     conf.setOutputValueClass(Text.class);
	
	     conf.setMapperClass(Map.class);
	     conf.setCombinerClass(Reduce.class);
	     conf.setReducerClass(Reduce.class);
	     
	     conf.setInputFormat(TextInputFormat.class);
	     conf.setOutputFormat(TextOutputFormat.class);
	
	     FileInputFormat.addInputPath(conf, new Path(args[0]));
	     FileOutputFormat.setOutputPath(conf, new Path(args[1]));
	
	     JobClient.runJob(conf);
	}

}